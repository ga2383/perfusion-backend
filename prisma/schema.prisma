generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum PerfusionMode {
  HOPE
  NMP
  TRANSITION
}

enum SystemState {
  IDLE
  PRIMING
  RUNNING
  PAUSED
  STOPPED
  ERROR
}

enum FlagLevel {
  OK
  WARN
  EMERGENCY
  SENSOR_FAIL
  DISCONNECTED
  UNKNOWN
}

//
// MODELS
//

model HopeRun {
  id          Int            @id @default(autoincrement())
  startedAt   DateTime       @default(now())
  finishedAt  DateTime?
  mode        PerfusionMode  @default(HOPE)
  state       SystemState    @default(IDLE)

  readings    HopeReading[]
  alarms      AlarmEvent[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model NmpRun {
  id          Int            @id @default(autoincrement())
  startedAt   DateTime       @default(now())
  finishedAt  DateTime?
  mode        PerfusionMode  @default(NMP)
  state       SystemState    @default(IDLE)

  readings    NmpReading[]
  alarms      AlarmEvent[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model HopeReading {
  id          Int        @id @default(autoincrement())
  runId       Int
  run         HopeRun    @relation(fields: [runId], references: [id], onDelete: Cascade)

  temperature Float?
  pressure    Float?
  flowRate    Float?
  oxygen      Float?

  flag        FlagLevel  @default(OK)

  createdAt   DateTime   @default(now())

  @@index([runId, createdAt])
}

model NmpReading {
  id          Int        @id @default(autoincrement())
  runId       Int
  run         NmpRun     @relation(fields: [runId], references: [id], onDelete: Cascade)

  temperature Float?
  pressure    Float?
  flowRate    Float?
  oxygen      Float?
  ph          Float?
  lactate     Float?

  flag        FlagLevel  @default(OK)

  createdAt   DateTime   @default(now())

  @@index([runId, createdAt])
}

model AlarmEvent {
  id          Int        @id @default(autoincrement())

  hopeRunId   Int?
  nmpRunId    Int?

  hopeRun     HopeRun?   @relation(fields: [hopeRunId], references: [id], onDelete: Cascade)
  nmpRun      NmpRun?    @relation(fields: [nmpRunId], references: [id], onDelete: Cascade)

  message     String
  level       FlagLevel
  acknowledged Boolean   @default(false)

  createdAt   DateTime   @default(now())

  @@index([createdAt])
}